- hosts: localhost
  gather_facts: true
  connection: local
  tasks:
    - include_vars: '{{ ansible_os_family | lower }}.yml'
    - set_fact:
        deps_dir: '{{ ansible_env.HOME }}/.cache/esearch-dev'
    - name: Create a directory for dependencies
      file:
        path: '{{ deps_dir }}'
        state: directory

    - name: Setup global dependencies
      block:
        - name: packages
          package:
            name: '{{ item }}'
            state: present
          become: '{{ package_become }}'
          with_items:
            - git
            - curl
            - ragel
            - unzip
            - neovim
            - luarocks
            - '{{ vim_package_name }}'
            - '{{ tar_package_name }}'
            - '{{ pip_package_name }}'
            - '{{ ps_package_name }}'
        - name: go
          shell: eval "$(curl -sL https://raw.githubusercontent.com/travis-ci/gimme/master/gimme | GIMME_GO_VERSION=1.14 bash)"
        - name: gohome
          lineinfile:
            path: '{{ ansible_env.HOME }}/.bashrc'
            state: present
            line: 'export PATH="$PATH:$HOME/go/bin"'
        - name: go path
          lineinfile:
            path: '{{ ansible_env.HOME }}/.bashrc'
            state: present
            line: '. ~/.gimme/envs/go1.14.env'
        - name: lua linter
          command: luarocks install luacheck
          become: '{{ package_become }}'
          args:
            creates: /usr/local/bin/luacheck
        - name: pip packages
          pip:
            name: ['vim-vint', 'neovim']
            state: present

    - name: Setup greppers
      block:
        - name: from system package manager
          package:
            name: '{{ item }}'
            state: present
          become: '{{ package_become }}'
          with_items:
            - '{{ ag_package_name }}'
            - '{{ ack_package_name }}'
        - name: From PIP
          pip:
            name: ['semgrep']
            state: present
        - name: From go-get
          shell: '. ~/.gimme/envs/go1.14.env && go get {{ item }}'
          environment:
            GO111MODULE: 'on'
          with_items:
            - mvdan.cc/gogrep
        - name: install prebuilt
          block:
            - name: download
              unarchive:
                src: '{{ item.download_url }}'
                dest: /tmp
                remote_src: true
              with_items: '{{ greppers }}'
            - name: find extracted binary
              find:
                paths: /tmp
                recurse: true
                patterns: '{{ item.bin }}'
              register: bins
              with_items: '{{ greppers }}'
            - name: copy into /usr/local/bin
              copy:
                src: '{{ item.path }}'
                dest: '/usr/local/bin/{{ item.path | basename }}'
              become: '{{ package_become }}'
              with_items: '{{ bins.results | map(attribute="files") | map("first") | list }}'
            - name: make executable
              file:
                dest: '/usr/local/bin/{{ item.bin }}'
                mode: a+x
              become: '{{ package_become }}'
              with_items: '{{ greppers }}'
          vars:
            - greppers:
                - {bin: pt, download_url: '{{ pt_download_url }}'}
                - {bin: rg, download_url: '{{ rg_download_url }}'}
        - name: configure git-grep
          block:
            - git_config: {scope: global, name: core.precomposeunicode, value: 'true'}
            - git_config: {scope: global, name: core.quotePath, value: 'false'}

    - name: setup plugin dependencies
      git:
        repo: '{{ item }}'
        dest: '{{ deps_dir }}/plugins/{{ item | urlsplit("path") | basename | splitext | first }}'
      with_items:
        - https://github.com/mg979/vim-visual-multi.git
        - https://github.com/tpope/vim-fugitive.git
        - https://github.com/preservim/nerdtree.git
        - https://github.com/justinmk/vim-dirvish.git
        - https://github.com/ipod825/vim-netranger.git
        - https://github.com/lambdalisue/fern.vim.git
        - https://github.com/Shougo/defx.nvim.git
        - https://github.com/roxma/nvim-yarp.git
        - https://github.com/roxma/vim-hug-neovim-rpc.git

    - name: setup testing dependencies
      block:
        - name: libs
          bundler:
            state: present
            extra_args: '--without development'
        - name: vader testing framework
          git:
            repo: https://github.com/junegunn/vader.vim.git
            dest: '{{ deps_dir }}/plugins/vader.vim'
